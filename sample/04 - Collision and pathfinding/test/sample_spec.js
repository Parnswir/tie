describe('04 - Collision and pathfinding', function() {

  it('renders the expected initial output', function() {
    cy.visit('http://localhost:8080/');
    cy.wait(1000);
    cy.document().then((document) => {
      const canvas = document.getElementById('canvas');
      expect(canvas.toDataURL()).to.equal("data:image/png;base64,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");
    });
  });

  it('moves the PC on click', function() {
    cy.visit('http://localhost:8080/');
    cy.wait(1000);

    // set up assertion after movement
    cy.window().then((window) => {
      window.tileEngine.getCharacter('example-npc').on('movementComplete', (event) => {
        cy.document().then((document) => {
          const canvas = document.getElementById('canvas');
          expect(canvas.toDataURL()).to.equal("data:image/png;base64,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");
        });
      });
    });

    // set player and NPC in motion
    cy.get('#canvas').click(70, 130);
  });

  it('resets the PC position when clicking on the button', function() {
    cy.visit('http://localhost:8080/');
    cy.wait(1000);

    // set up assertion after movement
    cy.window().then((window) => {
      const firstMovementComplete = (event) => {
        window.tileEngine.getCharacter('example-npc').on('once:movementComplete', secondMovementComplete);
        cy.get('#resetButton').click();
      };

      const secondMovementComplete = (event) => {
        cy.document().then((document) => {
          const canvas = document.getElementById('canvas');
          expect(canvas.toDataURL()).to.equal("data:image/png;base64,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");
        });
      }

      window.tileEngine.getCharacter('example-npc').on('once:movementComplete', firstMovementComplete);
    });

    // set player and NPC in motion
    cy.get('#canvas').click(130, 70);
  });
});
